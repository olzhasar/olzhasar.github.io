<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Consider the following Python code:
foo.py
import requests def main(): result = fetch_url() return &#34;Fetched: &#34; + result def fetch_url(url: str) -> str: response = requests.get() return response.text Let&rsquo;s say we would like to test our main function and we want to mock the piece of logic making external requests
test_foo.py
from unittest import mock from foo import main def test_main(): with mock.patch(&#34;foo.fetch_url&#34;) as mock_fetch: mock_fetch.return_value = &#34;Some response&#34; assert main() == &#34;Fetched: Some response&#34; The above test passes without any issues."><meta name=color-scheme content="light dark"><meta name=generator content="Hugo 0.110.0"><title>Use autospeccing for your mocks in Python | Olzhas Arystanov</title><link rel=canonical href=https://olzhasar.com/posts/use-autospeccing-for-your-mocks-in-python/><link rel=stylesheet href=/css/base.min.987b9baaf8b25b2526d9899fe232f7262bcfb1a8dea868a0aa5e4f7308b94a80.css integrity="sha256-mHubqviyWyUm2Ymf4jL3JivPsajeqGigql5Pcwi5SoA=" crossorigin=anonymous><script src=https://cdn.counter.dev/script.js data-id=3dd77a42-dfdd-4a54-b59c-cfff02697a3f data-utcoffset=6></script></head><body><nav class=u-background><div class=u-wrapper><ul class=Banner><li class="Banner-item Banner-item--title"><h1 class=Banner-heading><a class="Banner-link u-clickable" href=/>Olzhas Arystanov</a></h1></li><li class=Banner-item><a class="Banner-link u-clickable" href=/>Posts</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=/projects/>Projects</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=/about/>About</a></li></ul></div></nav><main><div class=u-wrapper><div class=u-padding><article><header class=Heading><h2 class=Heading-title><a class="Heading-link u-clickable" href=/posts/use-autospeccing-for-your-mocks-in-python/ rel=bookmark>Use autospeccing for your mocks in Python</a></h2><time datetime=2024-02-05T00:00:00Z>5 February, 2024</time></header><p>Consider the following Python code:</p><p><strong>foo.py</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py3 data-lang=py3><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> fetch_url()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Fetched: &#34;</span> <span style=color:#f92672>+</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fetch_url</span>(url: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>text</span></span></code></pre></div><p>Let&rsquo;s say we would like to test our main function and we want to mock the piece of logic making external requests</p><p><strong>test_foo.py</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py3 data-lang=py3><span style=display:flex><span><span style=color:#f92672>from</span> unittest <span style=color:#f92672>import</span> mock
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> foo <span style=color:#f92672>import</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> mock<span style=color:#f92672>.</span>patch(<span style=color:#e6db74>&#34;foo.fetch_url&#34;</span>) <span style=color:#66d9ef>as</span> mock_fetch:
</span></span><span style=display:flex><span>        mock_fetch<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Some response&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> main() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Fetched: Some response&#34;</span></span></span></code></pre></div><p>The above test passes without any issues. However, our code is broken cause we did not provide a required positional argument <code>url</code> in a call to the <code>fetch_url</code> function. The reason it happened is because mocks in Python <a href=https://docs.python.org/3/library/unittest.mock.html#quick-guide>create all attributes and methods as you access them</a> by default. Is there a way to prevent this? Yes, by providing a specification to the mock object. The class constructor accepts a <code>spec</code> argument which can be used to create specification from any existing object or a list of strings (used as list of arguments to create). However, python also provides a convenient <a href=https://docs.python.org/3/library/unittest.mock.html#autospeccing>autospeccing mechanism</a> to automatically create spec based on api of the object being mocked. Let&rsquo;s see the updated test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py3 data-lang=py3><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> mock<span style=color:#f92672>.</span>patch(<span style=color:#e6db74>&#34;foo.fetch_url&#34;</span>, autospec<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>) <span style=color:#66d9ef>as</span> mock_fetch:
</span></span><span style=display:flex><span>        mock_fetch<span style=color:#f92672>.</span>return_value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Some response&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> main() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Fetched: Some response&#34;</span></span></span></code></pre></div><p>The result of the above test is now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>FAILED test_foo.py::test_main - TypeError: missing a required argument: <span style=color:#e6db74>&#39;url&#39;</span></span></span></code></pre></div><footer><ul class=Tags><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=/tags/python/ rel=tag>python</a></li><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=/tags/tdd/ rel=tag>tdd</a></li></ul></footer></article></div></div></main><footer class=Footer><div class=u-wrapper><div class=u-padding>Â© Olzhas Arystanov 2021-2024</div></div></footer></body></html>