<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Task prioritization can be an effective technique to ensure the most critical tasks are processed in time. There are other ways to achieve this, like using dedicated workers, but prioritizing is arguably the simplest, and in many cases, the most cost-effective approach. Celery supports task prioritization natively, but it works differently depending on the broker you use. If you use RabbitMQ, for example, prioritizing will be handled on the broker side, meaning that the broker will decide which message to deliver first."><meta name=color-scheme content="light dark"><meta name=generator content="Hugo 0.110.0"><title>Prioritizing Tasks With Celery and Redis | Olzhas Arystanov</title><link rel=canonical href=https://olzhasar.com/posts/prioritizing-tasks-with-celery-and-redis/><link rel=stylesheet href=/css/base.min.987b9baaf8b25b2526d9899fe232f7262bcfb1a8dea868a0aa5e4f7308b94a80.css integrity="sha256-mHubqviyWyUm2Ymf4jL3JivPsajeqGigql5Pcwi5SoA=" crossorigin=anonymous><script src=https://cdn.counter.dev/script.js data-id=3dd77a42-dfdd-4a54-b59c-cfff02697a3f data-utcoffset=6></script></head><body><nav class=u-background><div class=u-wrapper><ul class=Banner><li class="Banner-item Banner-item--title"><h1 class=Banner-heading><a class="Banner-link u-clickable" href=/>Olzhas Arystanov</a></h1></li><li class=Banner-item><a class="Banner-link u-clickable" href=/>Posts</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=/projects/>Projects</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=/about/>About</a></li></ul></div></nav><main><div class=u-wrapper><div class=u-padding><article><header class=Heading><h2 class=Heading-title><a class="Heading-link u-clickable" href=/posts/prioritizing-tasks-with-celery-and-redis/ rel=bookmark>Prioritizing Tasks With Celery and Redis</a></h2><time datetime=2024-09-01T21:32:41+05:00>1 September, 2024</time></header><p>Task prioritization can be an effective technique to ensure the most critical tasks are processed in time. There are other ways to achieve this, like using dedicated workers, but prioritizing is arguably the simplest, and in many cases, the most cost-effective approach. Celery supports task prioritization natively, but it works differently depending on the broker you use. If you use RabbitMQ, for example, prioritizing will be handled on the broker side, meaning that the broker will decide which message to deliver first. However, RabbitMQ might be an overkill for a lot of projects, and Redis is often preferred due to its simplicity. It turns out, one can still prioritize tasks with Redis, but it works in a slightly different fashion.</p><h2 id=how-task-prioritization-works-in-celery-with-redis-as-a-broker><a class="Heading-link u-clickable" href=/posts/prioritizing-tasks-with-celery-and-redis/#how-task-prioritization-works-in-celery-with-redis-as-a-broker>How task prioritization works in Celery with Redis as a broker</a></h2><p>Redis, being essentially a key-value store, doesn&rsquo;t support task priorities out of the box. However, <code>celery</code> emulates broker-side priorities by using separate queues for different priority levels. When you send a task with a certain priority level, it will be placed in a corresponding queue. The worker will then decide which queue to consume tasks from based on the queue priority. As celery docs state, this will never be as good as broker-side prioritization, but in my experience, it works well enough.</p><h2 id=setting-up-task-priorities-with-celery-and-redis><a class="Heading-link u-clickable" href=/posts/prioritizing-tasks-with-celery-and-redis/#setting-up-task-priorities-with-celery-and-redis>Setting up task priorities with Celery and Redis</a></h2><p>Firstly, you need to set the <code>queue_order_strategy</code> in the celery configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>app<span style=color:#f92672>.</span>conf<span style=color:#f92672>.</span>broker_transport_options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;queue_order_strategy&#39;</span>: <span style=color:#e6db74>&#39;priority&#39;</span>,
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Or, if you are configuring <code>celery</code> from <code>django</code> settings:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>CELERY_BROKER_TRANSPORT_OPTIONS <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;queue_order_strategy&#39;</span>: <span style=color:#e6db74>&#39;priority&#39;</span>,
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><code>celery</code> creates 4 queues by default, while the priority levels are 0-9. I personally find it confusing, so I prefer to explicitly define the queues:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>app<span style=color:#f92672>.</span>conf<span style=color:#f92672>.</span>broker_transport_options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;priority_steps&#39;</span>: list(range(<span style=color:#ae81ff>10</span>)),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;sep&#39;</span>: <span style=color:#e6db74>&#39;:&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;queue_order_strategy&#39;</span>: <span style=color:#e6db74>&#39;priority&#39;</span>,
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>We now have 10 separate queues for each priority level (0-9).</p><p><strong>IMPORTANT</strong>: Lower values correspond to higher priority levels, so tasks with 0 priority value will be processed first.</p><p>Last thing, we need to make sure we don&rsquo;t prefetch a lot of tasks at once, otherwise, prioritization will not make much sense. Imagine your worker prefetched 10 tasks in advance, and something critical comes up. You will have to wait for existing (probably less important) tasks to get finished before you can proceed with the critical one. There is a <code>worker_prefetch_multiplier</code> setting responsible for this behavior. The value defaults to 4, to spend less time fetching, but if we want robust prioritization, value of 1 will be best:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>app<span style=color:#f92672>.</span>conf<span style=color:#f92672>.</span>worker_prefetch_multiplier <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span></span></span></code></pre></div><p>That&rsquo;s it! We now have task prioritization set up with Celery and Redis.</p><h2 id=task-prioritization-in-practice><a class="Heading-link u-clickable" href=/posts/prioritizing-tasks-with-celery-and-redis/#task-prioritization-in-practice>Task prioritization in practice</a></h2><p>Priorities can be set when defining a task:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.task</span>(priority<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>critical_task</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.task</span>(priority<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>regular_task</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.task</span>(priority<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>not_so_important_task</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span></span></span></code></pre></div><p>You can also override the priority when sending a task:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>critical_task<span style=color:#f92672>.</span>apply_async(args<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;foo&#39;</span>], kwargs<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;bar&#39;</span>: <span style=color:#ae81ff>1</span>}, priority<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)</span></span></code></pre></div></article></div></div></main><footer class=Footer><div class=u-wrapper><div class=u-padding>Â© Olzhas Arystanov 2021-2024</div></div></footer></body></html>